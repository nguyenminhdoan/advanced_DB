<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | HR Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-users"></i> HR Management System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employees</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/departments"><i class="fas fa-building"></i> Departments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/leaves"><i class="fas fa-calendar-alt"></i> Leave Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/performance"><i class="fas fa-chart-line"></i> Performance</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-file-alt"></i> Reports
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/performance/top-performers">Top Performers</a></li>
                            <li><a class="dropdown-item" href="/reports/audit">Audit Log</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Flash Messages -->
        <% if (typeof session !== 'undefined' && session.message) { %>
            <div class="alert alert-<%= session.message.type === 'error' ? 'danger' : session.message.type %> alert-dismissible fade show">
                <%= session.message.text %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% delete session.message; %>
        <% } %>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2"><i class="fas fa-calendar-alt"></i> Leave Requests</h1>
                <p class="text-muted">Manage employee leave requests and approvals</p>
            </div>
        </div>

        <!-- Process Pending Leaves -->
        <% if (leaves.filter(l => l.STATUS === 'PENDING').length > 0) { %>
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-clock"></i> Process Pending Leaves
                    <span class="badge bg-dark ms-2"><%= leaves.filter(l => l.STATUS === 'PENDING').length %></span>
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Use the PL/SQL procedure to automatically process pending leave requests:</p>
                <form action="/leaves/process" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <label for="approver_id" class="form-label">Approver ID <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="approver_id" name="approver_id" 
                               required placeholder="Enter approver employee ID" value="1001">
                        <div class="form-text">Employee ID of the person approving leaves</div>
                    </div>
                    <div class="col-md-4">
                        <label for="days_threshold" class="form-label">Auto-approve Threshold</label>
                        <input type="number" class="form-control" id="days_threshold" name="days_threshold" 
                               value="5" min="1" max="30">
                        <div class="form-text">Leaves <= this many days will be auto-approved</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-warning d-block">
                            <i class="fas fa-cogs"></i> Process Pending Leaves
                        </button>
                    </div>
                </form>
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> Uses <code>process_pending_leaves</code> PL/SQL procedure with cursor
                </small>
            </div>
        </div>
        <% } %>

        <!-- Leave Requests Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> All Leave Requests</h5>
            </div>
            <div class="card-body">
                <% if (leaves.length === 0) { %>
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                        <h5>No Leave Requests</h5>
                        <p class="text-muted">No leave requests have been submitted yet.</p>
                    </div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Request ID</th>
                                    <th>Employee</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Days</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Approver</th>
                                    <th>Requested On</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% leaves.forEach(leave => { %>
                                    <tr>
                                        <td><strong><%= leave.LEAVE_ID %></strong></td>
                                        <td><%= leave.EMPLOYEE_NAME %></td>
                                        <td><%= new Date(leave.START_DATE).toLocaleDateString() %></td>
                                        <td><%= new Date(leave.END_DATE).toLocaleDateString() %></td>
                                        <td>
                                            <span class="badge bg-info"><%= leave.DAYS %></span>
                                        </td>
                                        <td>
                                            <% if (leave.REASON && leave.REASON.length > 30) { %>
                                                <span title="<%= leave.REASON %>">
                                                    <%= leave.REASON.substring(0, 30) %>...
                                                </span>
                                            <% } else { %>
                                                <%= leave.REASON || 'No reason provided' %>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (leave.STATUS === 'PENDING') { %>
                                                <span class="badge bg-warning">Pending</span>
                                            <% } else if (leave.STATUS === 'APPROVED') { %>
                                                <span class="badge bg-success">Approved</span>
                                            <% } else if (leave.STATUS === 'REJECTED') { %>
                                                <span class="badge bg-danger">Rejected</span>
                                            <% } %>
                                        </td>
                                        <td><%= leave.APPROVER_NAME || 'N/A' %></td>
                                        <td><%= new Date(leave.REQUEST_DATE).toLocaleDateString() %></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Leave Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1 text-primary"><%= leaves.length %></h4>
                                    <small class="text-muted">Total Requests</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1 text-warning"><%= leaves.filter(l => l.STATUS === 'PENDING').length %></h4>
                                    <small class="text-muted">Pending</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1 text-success"><%= leaves.filter(l => l.STATUS === 'APPROVED').length %></h4>
                                    <small class="text-muted">Approved</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1 text-danger"><%= leaves.filter(l => l.STATUS === 'REJECTED').length %></h4>
                                    <small class="text-muted">Rejected</small>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- PL/SQL Information -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-database"></i> PL/SQL Integration</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-code text-primary"></i> Procedure Used</h6>
                                <code>process_pending_leaves(approver_id, days_threshold)</code>
                                <p class="small text-muted mt-2">
                                    This procedure uses a cursor to iterate through pending leave requests 
                                    and automatically approves those within the specified threshold. 
                                    Includes exception handling and transaction management.
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-cogs text-success"></i> Features</h6>
                                <ul class="small mb-0">
                                    <li>Cursor-based processing of pending requests</li>
                                    <li>Configurable approval threshold</li>
                                    <li>Validates approver exists and is active</li>
                                    <li>Exception handling for errors</li>
                                    <li>Automatic commit/rollback</li>
                                    <li>Detailed logging of processed requests</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0 text-muted">&copy; 2024 HR Management System - COMP214 Database Project</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/script.js"></script>
</body>
</html>