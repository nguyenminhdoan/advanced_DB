<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | HR Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-users"></i> HR Management System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employees</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/departments"><i class="fas fa-building"></i> Departments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/leaves"><i class="fas fa-calendar-alt"></i> Leave Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/performance"><i class="fas fa-chart-line"></i> Performance</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-file-alt"></i> Reports
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/performance/top-performers">Top Performers</a></li>
                            <li><a class="dropdown-item active" href="/reports/audit">Audit Log</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Flash Messages -->
        <% if (typeof session !== 'undefined' && session.message) { %>
            <div class="alert alert-<%= session.message.type === 'error' ? 'danger' : session.message.type %> alert-dismissible fade show">
                <%= session.message.text %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% delete session.message; %>
        <% } %>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2"><i class="fas fa-clipboard-list"></i> Audit Log</h1>
                <p class="text-muted">System audit trail for employee data changes</p>
            </div>
        </div>

        <!-- Audit Log Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> Recent System Changes
                    <span class="badge bg-info ms-2">Last 50 entries</span>
                </h5>
            </div>
            <div class="card-body">
                <% if (logs.length === 0) { %>
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <h5>No Audit Entries</h5>
                        <p class="text-muted">No audit log entries found in the system.</p>
                    </div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Log ID</th>
                                    <th>Table</th>
                                    <th>Operation</th>
                                    <th>Employee ID</th>
                                    <th>Old Values</th>
                                    <th>New Values</th>
                                    <th>Changed By</th>
                                    <th>Date & Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% logs.forEach(log => { %>
                                    <tr>
                                        <td><strong><%= log.LOG_ID %></strong></td>
                                        <td>
                                            <span class="badge bg-secondary"><%= log.TABLE_NAME %></span>
                                        </td>
                                        <td>
                                            <% if (log.OPERATION === 'INSERT') { %>
                                                <span class="badge bg-success"><i class="fas fa-plus"></i> INSERT</span>
                                            <% } else if (log.OPERATION === 'UPDATE') { %>
                                                <span class="badge bg-warning"><i class="fas fa-edit"></i> UPDATE</span>
                                            <% } else if (log.OPERATION === 'DELETE') { %>
                                                <span class="badge bg-danger"><i class="fas fa-trash"></i> DELETE</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (log.EMP_ID) { %>
                                                <a href="/employees/<%= log.EMP_ID %>" class="text-decoration-none">
                                                    <%= log.EMP_ID %>
                                                </a>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (log.OLD_VALUES) { %>
                                                <small class="text-muted" title="<%= log.OLD_VALUES %>">
                                                    <%= log.OLD_VALUES.length > 40 ? log.OLD_VALUES.substring(0, 40) + '...' : log.OLD_VALUES %>
                                                </small>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (log.NEW_VALUES) { %>
                                                <small class="text-primary" title="<%= log.NEW_VALUES %>">
                                                    <%= log.NEW_VALUES.length > 40 ? log.NEW_VALUES.substring(0, 40) + '...' : log.NEW_VALUES %>
                                                </small>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <small class="text-muted"><%= log.CHANGED_BY %></small>
                                        </td>
                                        <td>
                                            <small>
                                                <%= new Date(log.CHANGE_DATE).toLocaleDateString() %>
                                                <br>
                                                <span class="text-muted"><%= new Date(log.CHANGE_DATE).toLocaleTimeString() %></span>
                                            </small>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Audit Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1 text-primary"><%= logs.length %></h4>
                                    <small class="text-muted">Total Entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <% const inserts = logs.filter(l => l.OPERATION === 'INSERT').length; %>
                                    <h4 class="mb-1 text-success"><%= inserts %></h4>
                                    <small class="text-muted">Inserts</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <% const updates = logs.filter(l => l.OPERATION === 'UPDATE').length; %>
                                    <h4 class="mb-1 text-warning"><%= updates %></h4>
                                    <small class="text-muted">Updates</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <% const deletes = logs.filter(l => l.OPERATION === 'DELETE').length; %>
                                    <h4 class="mb-1 text-danger"><%= deletes %></h4>
                                    <small class="text-muted">Deletes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Operation Analysis -->
        <% if (logs.length > 0) { %>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Operation Distribution</h6>
                    </div>
                    <div class="card-body">
                        <% 
                        const inserts = logs.filter(l => l.OPERATION === 'INSERT').length;
                        const updates = logs.filter(l => l.OPERATION === 'UPDATE').length;
                        const deletes = logs.filter(l => l.OPERATION === 'DELETE').length;
                        %>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-plus text-success"></i> Inserts</span>
                                <span class="badge bg-success"><%= inserts %></span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: <%= logs.length > 0 ? (inserts / logs.length) * 100 : 0 %>%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-edit text-warning"></i> Updates</span>
                                <span class="badge bg-warning"><%= updates %></span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: <%= logs.length > 0 ? (updates / logs.length) * 100 : 0 %>%"></div>
                            </div>
                        </div>
                        <div class="mb-0">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-trash text-danger"></i> Deletes</span>
                                <span class="badge bg-danger"><%= deletes %></span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: <%= logs.length > 0 ? (deletes / logs.length) * 100 : 0 %>%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-clock"></i> Recent Activity</h6>
                    </div>
                    <div class="card-body">
                        <% 
                        const recentLogs = logs
                            .sort((a, b) => new Date(b.CHANGE_DATE) - new Date(a.CHANGE_DATE))
                            .slice(0, 5);
                        %>
                        <% recentLogs.forEach(log => { %>
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div>
                                    <small>
                                        <% if (log.OPERATION === 'INSERT') { %>
                                            <span class="badge bg-success badge-sm"><i class="fas fa-plus"></i></span>
                                        <% } else if (log.OPERATION === 'UPDATE') { %>
                                            <span class="badge bg-warning badge-sm"><i class="fas fa-edit"></i></span>
                                        <% } else if (log.OPERATION === 'DELETE') { %>
                                            <span class="badge bg-danger badge-sm"><i class="fas fa-trash"></i></span>
                                        <% } %>
                                        <strong><%= log.TABLE_NAME %></strong>
                                        <% if (log.EMP_ID) { %>- Employee <%= log.EMP_ID %><% } %>
                                    </small>
                                    <br>
                                    <small class="text-muted">by <%= log.CHANGED_BY %></small>
                                </div>
                                <small class="text-muted">
                                    <%= new Date(log.CHANGE_DATE).toLocaleDateString() %>
                                </small>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Audit Trigger Information -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-database"></i> Automatic Audit Logging</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-bolt text-warning"></i> Trigger: trg_emp_audit</h6>
                                <p class="small text-muted mb-2">
                                    The audit log is automatically populated by a database trigger that fires after 
                                    INSERT, UPDATE, or DELETE operations on the employees table. The trigger captures 
                                    the operation type, old and new values, and the user who made the change.
                                </p>
                                <div class="bg-white p-2 rounded">
                                    <code class="small">
                                        CREATE OR REPLACE TRIGGER trg_emp_audit<br>
                                        &nbsp;&nbsp;AFTER INSERT OR UPDATE OR DELETE ON employees<br>
                                        &nbsp;&nbsp;FOR EACH ROW<br>
                                        BEGIN<br>
                                        &nbsp;&nbsp;-- Log operation details to audit_log table<br>
                                        END;
                                    </code>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-shield-alt text-success"></i> Security Features</h6>
                                <ul class="small mb-0">
                                    <li>Automatic logging of all changes</li>
                                    <li>Captures old and new values</li>
                                    <li>Records user who made changes</li>
                                    <li>Timestamp of all operations</li>
                                    <li>Cannot be bypassed by applications</li>
                                    <li>Provides complete audit trail</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0 text-muted">&copy; 2024 HR Management System - COMP214 Database Project</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/script.js"></script>
</body>
</html>